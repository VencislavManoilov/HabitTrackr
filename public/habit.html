<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="./main.css">
    <link rel="stylesheet" type="text/css" href="./css/habit.css">

    <title>HabitTrackr</title>
</head>

<body onload="init()">
    <p id="error"></p>
    <button id="back" onclick="document.location.href='home'"><</button>

    <div id="contents">

        <p id="habit"></p>

        <p id="goal">Цел</p>

        
        <div id="asdf">
            <p id="month"></p>
            <div id="days"></div>
            <div id="graph"></div>
        </div>

        <button id="delete" onclick="deleteHabit()">Delete</button>
    </div>
</body>

<script src="cookies.js"></script>

<script>
    const xhr = new XMLHttpRequest();
    let habit, user, months = ["Януари", "Февруари", "Март", "Април", "Май", "Юни", "Юли", "Август", "Септември", "Октомври", "Ноември", "Декември"];

    function init() {
        const searchParams = new URLSearchParams(window.location.search);

        if(searchParams.has("id")) {
            xhr.open("GET", "/habit/get?id=" + searchParams.get("id"), true);
            xhr.send();
            xhr.onload = () => {
                const data = JSON.parse(xhr.response);
                if(data.error) {
                    document.location.href = "/home";
                } else {
                    habit = data;
                    formData(data);

                    xhr.open("GET", "/user");
                    xhr.send();
                    xhr.onload = () => {
                        user = JSON.parse(xhr.response);
                    }
                }
            }
        } else {
            document.location.href = "/home";
        }
    }

    function formData(data) {
        document.getElementById("habit").innerHTML = data.text;
        // document.getElementById("goal").innerHTML = `Цел: ${data.streak}/${data.goal}`;
        document.getElementById("goal").innerHTML = `Цел: ${(data.streak / data.goal) * 100}%`;

        let graph = document.getElementById("graph");
        graph.innerHTML = "";

        document.getElementById("days").innerHTML = "<span>П</span><span>В</span><span>С</span><span>Ч</span><span>П</span><span>С</span><span>Н</span>";

        let currentDate = new Date();
        let firstDayOfTheMonth = new Date((currentDate.getMonth() + 1) + "/1/" + currentDate.getFullYear());
        let lastDayOfTheMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);

        document.getElementById("month").textContent = months[currentDate.getMonth()];
        
        for(let i = firstDayOfTheMonth.getDay() - 1; i > 0 ; i--) {
            let daysElement = document.createElement("div");
            daysElement.classList.add("day");
            daysElement.classList.add("lastMonth");
            let date = new Date().setDate(firstDayOfTheMonth.getDate() - i);
            daysElement.innerHTML = "<p>" + new Date(currentDate.getFullYear(), currentDate.getMonth(), firstDayOfTheMonth.getDate() - i).getDate() + "</p>";
            graph.appendChild(daysElement);
        }

        for(let i = 0; i < currentDate.getDate(); i++) {
            let daysElement = document.createElement("div");
            daysElement.classList.add("day");
            
            let date = new Date(currentDate.getFullYear(), currentDate.getMonth(), firstDayOfTheMonth.getDate() + i);

            for(let j = 0; j < habit.graph.length; j++) {
                if(date.getDate() == new Date(habit.graph[j].day).getDate() && date.getMonth() == new Date(habit.graph[j].day).getMonth()) {
                    daysElement.classList.add(habit.graph[j].check ? "done" : "not-done");
                    j = habit.graph.length;
                }
            }

            daysElement.innerHTML = "<p>" + date.getDate() + "</p>";
            graph.appendChild(daysElement);
        }

        for(let i = 1; i <= lastDayOfTheMonth.getDate() - currentDate.getDate(); i++) {
            let daysElement = document.createElement("div");
            daysElement.classList.add("day");
            daysElement.classList.add("futureThisMonth");
            daysElement.innerHTML = "<p>" + new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate() + i).getDate() + "</p>";
            graph.appendChild(daysElement);
        }

        for(let i = 1; i < 8 - lastDayOfTheMonth.getDay(); i++) {
            let daysElement = document.createElement("div");
            daysElement.classList.add("day");
            daysElement.classList.add("nextMonth");
            let date = new Date().setDate(lastDayOfTheMonth.getDate() + i);
            daysElement.innerHTML = "<p>" + new Date(currentDate.getFullYear(), currentDate.getMonth(), lastDayOfTheMonth.getDate() + i).getDate() + "</p>";
            graph.appendChild(daysElement);
        }
    }

    function deleteHabit() {
        fetch("/habit/delete", {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
            body: new URLSearchParams({
                id: user.id,
                habitId: habit.id
            })
        })
        .then((resp) => {
            setTimeout(() => {
                return resp.json()
                    .then(function(response) {
                        if (response.error) {
                            document.getElementById("error").innerHTML = response.error;
                        } else {
                            user.habits = response;
                            document.location.href = "/home";
                        }
                        return response;
                    });
            }, 300);
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
</script>

</html>