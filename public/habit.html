<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" type="text/css" href="./main.css">
    <link rel="stylesheet" type="text/css" href="./css/habit.css">

    <title>HabitTrackr</title>
</head>

<body onload="init()">
    <svg preserveAspectRatio="xMidYMid slice" viewBox="10 10 80 80" id="background"><defs><style>@keyframes rotate {0% {transform: rotate(0deg);}100% {transform: rotate(360deg);}}.out-top {animation: rotate 20s linear infinite;transform-origin: 13px 25px;}.in-top {animation: rotate 10s linear infinite;transform-origin: 13px 25px;}.out-bottom {animation: rotate 25s linear infinite;transform-origin: 84px 93px;}.in-bottom {animation: rotate 15s linear infinite;transform-origin: 84px 93px;}</style></defs><path fill="#9b5de5" class="out-top" d="M37-5C25.1-14.7,5.7-19.1-9.2-10-28.5,1.8-32.7,31.1-19.8,49c15.5,21.5,52.6,22,67.2,2.3C59.4,35,53.7,8.5,37-5Z"/><path fill="#f15bb5" class="in-top" d="M20.6,4.1C11.6,1.5-1.9,2.5-8,11.2-16.3,23.1-8.2,45.6,7.4,50S42.1,38.9,41,24.5C40.2,14.1,29.4,6.6,20.6,4.1Z"/><path fill="#00bbf9" class="out-bottom" d="M105.9,48.6c-12.4-8.2-29.3-4.8-39.4.8-23.4,12.8-37.7,51.9-19.1,74.1s63.9,15.3,76-5.6c7.6-13.3,1.8-31.1-2.3-43.8C117.6,63.3,114.7,54.3,105.9,48.6Z"/><path fill="#00f5d4" class="in-bottom" d="M102,67.1c-9.6-6.1-22-3.1-29.5,2-15.4,10.7-19.6,37.5-7.6,47.8s35.9,3.9,44.5-12.5C115.5,92.6,113.9,74.6,102,67.1Z"/></svg>

    <p id="error"></p>
    <button id="back" onclick="document.location.href='home'"><</button>

    <div id="contents">

        <p id="habit"></p>

        <p id="streak"></p>
        <p id="maxStreak"></p>
        <p id="goal"></p>

        <p id="month"></p>

        <div id="days"></div>

        <div id="graph"></div>

        <button id="delete" onclick="deleteHabit()">Delete</button>
    </div>
</body>

<script src="cookies.js"></script>

<script>
    const xhr = new XMLHttpRequest();
    let habit, user, months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December",];

    function init() {
        const searchParams = new URLSearchParams(window.location.search);

        if(searchParams.has("id")) {
            xhr.open("GET", "/habit/get?id=" + searchParams.get("id"), true);
            xhr.send();
            xhr.onload = () => {
                const data = JSON.parse(xhr.response);
                if(data.error) {
                    document.location.href = "/home";
                } else {
                    habit = data;
                    formData(data);

                    xhr.open("GET", "/user");
                    xhr.send();
                    xhr.onload = () => {
                        user = JSON.parse(xhr.response);
                    }
                }
            }
        } else {
            document.location.href = "/home";
        }
    }

    function formData(data) {
        document.getElementById("habit").innerHTML = data.text;
        document.getElementById("streak").innerHTML = "Streak: " + data.streak;
        document.getElementById("maxStreak").innerHTML = "Max streak: " + data.maxStreak;
        document.getElementById("goal").innerHTML = "Goal: " + data.goal;

        let graph = document.getElementById("graph");
        graph.innerHTML = "";

        document.getElementById("days").innerHTML = "<span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span><span>Su</span>";

        let currentDate = new Date();
        let firstDayOfTheMonth = new Date((currentDate.getMonth() + 1) + "/1/" + currentDate.getFullYear());
        let lastDayOfTheMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);

        document.getElementById("month").textContent = months[currentDate.getMonth()];
        
        for(let i = firstDayOfTheMonth.getDay() - 1; i > 0 ; i--) {
            let daysElement = document.createElement("div");
            daysElement.classList.add("day");
            daysElement.classList.add("lastMonth");
            let date = new Date().setDate(firstDayOfTheMonth.getDate() - i);
            daysElement.innerHTML = "<p>" + new Date(currentDate.getFullYear(), currentDate.getMonth(), firstDayOfTheMonth.getDate() - i).getDate() + "</p>";
            graph.appendChild(daysElement);
        }

        for(let i = 0; i < currentDate.getDate(); i++) {
            let daysElement = document.createElement("div");
            daysElement.classList.add("day");
            
            let date = new Date(currentDate.getFullYear(), currentDate.getMonth(), firstDayOfTheMonth.getDate() + i);

            for(let j = 0; j < habit.graph.length; j++) {
                if(date.getDate() == new Date(habit.graph[j].day).getDate() && date.getMonth() == new Date(habit.graph[j].day).getMonth()) {
                    daysElement.classList.add(habit.graph[j].check ? "done" : "not-done");
                    j = habit.graph.length;
                }
            }

            daysElement.innerHTML = "<p>" + date.getDate() + "</p>";
            graph.appendChild(daysElement);
        }

        for(let i = 1; i <= lastDayOfTheMonth.getDate() - currentDate.getDate(); i++) {
            let daysElement = document.createElement("div");
            daysElement.classList.add("day");
            daysElement.classList.add("futureThisMonth");
            daysElement.innerHTML = "<p>" + new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate() + i).getDate() + "</p>";
            graph.appendChild(daysElement);
        }

        for(let i = 1; i < 8 - lastDayOfTheMonth.getDay(); i++) {
            let daysElement = document.createElement("div");
            daysElement.classList.add("day");
            daysElement.classList.add("nextMonth");
            let date = new Date().setDate(lastDayOfTheMonth.getDate() + i);
            daysElement.innerHTML = "<p>" + new Date(currentDate.getFullYear(), currentDate.getMonth(), lastDayOfTheMonth.getDate() + i).getDate() + "</p>";
            graph.appendChild(daysElement);
        }
    }

    function deleteHabit() {
        fetch("/habit/delete", {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
            body: new URLSearchParams({
                id: user.id,
                habitId: habit.id
            })
        })
        .then((resp) => {
            setTimeout(() => {
                return resp.json()
                    .then(function(response) {
                        if (response.error) {
                            document.getElementById("error").innerHTML = response.error;
                        } else {
                            user.habits = response;
                            document.location.href = "/home";
                        }
                        return response;
                    });
            }, 300);
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
</script>

</html>